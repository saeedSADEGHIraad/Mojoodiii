<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ú¯Ù†Ø¬ÛŒÙ†Ù‡ â€“ Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø·Ù„Ø§ÙØ±ÙˆØ´ÛŒ</title>
<meta name="theme-color" content="#D4AF37">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="icons/icon-192.png">
  <input id="file-upload" type="file" accept="image/*" class="d-none">
  <input id="file-camera" type="file" accept="image/*" class="d-none">
  <style>
  .container{padding:12px}
  .card{padding:14px}
  .row{gap:8px}
  .col{flex:1 1 100%}
  .select,.input{padding:14px 16px;font-size:1rem}
  .i-btn,.btn-ghost{padding:12px 14px;font-size:1rem}
  .btn-sm{padding:10px 12px}
  .cal-cell{padding:14px 0;min-height:54px;font-size:1rem}
  .thumb{width:72px;height:72px}
  .thumb-wrap{gap:10px}
  .item{grid-template-columns:1fr}
  .item-actions{justify-content:flex-start}
  .tabs{bottom:8px}
  .tabs-inner{padding:6px}
  #daily-toolbar{flex-wrap:wrap}
  .inline-actions{inset-inline-end:6px}
  .pill{padding:8px 12px}

/* decimal helper button (visible on small screens to aid mobile keyboards without decimal key) */
.input-with-dec{display:flex;align-items:center;gap:8px}
.input-with-dec .input{flex:1;width:auto}
.dec-btn{display:none;border:none;background:rgba(255,255,255,.04);color:var(--text);padding:12px 14px;border-radius:12px;cursor:pointer;flex:0 0 auto;min-width:var(--touch-size);min-height:var(--touch-size)}
@media(max-width:760px){ .dec-btn{display:inline-flex;z-index:6;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.06)} }
</style>
  .mb-10{margin-bottom:10px}
  .mb-8{margin-bottom:8px}
  .d-none{display:none}

  .date-card{background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));border:1px solid rgba(212,175,55,0.12);border-radius:18px;box-shadow:0 10px 40px rgba(0,0,0,0.45)}
  .date-card{transition:transform var(--transition-med) cubic-bezier(.2,.9,.3,1),opacity var(--transition-med) ease,max-height var(--transition-med) ease;transform-origin:top center}
  .date-card.hidden{opacity:0;transform:translateY(-8px) scale(.995);pointer-events:none;max-height:0;overflow:hidden}
  .date-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .date-title{display:flex;align-items:center;gap:10px;font-weight:800;color:var(--brand)}
  .date-title .emoji{font-size:1.2rem}
  .jalali-input{display:flex;gap:8px;align-items:center;margin-top:6px}
  .jalali-input .input{flex:1}
  .date-actions{display:flex;gap:8px;justify-content:center;margin-top:10px}
  .i-btn.success{background:linear-gradient(135deg,#22c55e,#16a34a);color:#07110a;border:none;font-weight:800}
  .i-btn.danger{background:linear-gradient(135deg,#ef4444,#dc2626);color:#230b0b;border:none;font-weight:800}
  .i-btn{transition:transform var(--transition-fast) ease,box-shadow var(--transition-fast) ease}
  .i-btn:hover{transform:translateY(-3px);box-shadow:var(--elev-1)}
  .i-btn:active{transform:translateY(0)}
  .calendar{margin-top:10px;border:1px solid rgba(255,255,255,.03);border-radius:14px;padding:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00))}
  .cal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .cal-head .nav{display:flex;gap:6px}
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .cal-cell{padding:10px 0;min-height:44px;border-radius:10px;text-align:center;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.03);cursor:pointer}
  .cal-cell.muted{opacity:.6}
  .cal-cell.today{outline:2px solid var(--brand);}
  .cal-cell.selected{background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#232211;border:none}
  .old-selects{display:none}
  .date-preview{margin-top:10px;display:flex;gap:8px;align-items:center;color:var(--text);font-weight:700}
  .badge{padding:6px 10px;font-weight:700;box-shadow:0 6px 20px rgba(0,0,0,0.45)}

  /* appbar date chip */
  #date-chip{display:none;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:linear-gradient(180deg, rgba(212,175,55,0.06), rgba(212,175,55,0.02));color:var(--brand);border:1px solid rgba(212,175,55,0.12);cursor:pointer;font-weight:700}
  #open-date-btn svg{margin-inline-start:6px;opacity:.95;transform:translateY(1px)}
  @media(max-width:480px){.cal-cell{padding:12px 0;min-height:48px}}
  /* Mobile optimizations */
  @media(max-width:640px){
    body{padding-bottom:160px}
    .appbar-inner{padding:10px 12px}
    .app-title{font-size:1.02rem}
    .app-subtitle{display:none}
    .appbar-actions{gap:6px}
    #date-chip{display:none}
    .container{padding:12px}
    .card{padding:14px}
    .row{gap:8px}
    .col{flex:1 1 100%}
    .select,.input{padding:14px 16px;font-size:1rem}
    .i-btn,.btn-ghost{padding:12px 14px;font-size:1rem}
    .btn-sm{padding:10px 12px}
    .cal-cell{padding:14px 0;min-height:54px;font-size:1rem}
    .thumb{width:72px;height:72px}
    .thumb-wrap{gap:10px}
    .item{grid-template-columns:1fr}
    .item-actions{justify-content:flex-start}
    .tabs{bottom:8px}
    .tabs-inner{padding:6px}
    #daily-toolbar{flex-wrap:wrap}
    .inline-actions{inset-inline-end:6px}
    .pill{padding:8px 12px}
  }

  /* decimal helper button (visible on small screens to aid mobile keyboards without decimal key) */
  .input-with-dec{display:flex;align-items:center;gap:8px}
  .input-with-dec .input{flex:1;width:auto}
  .dec-btn{display:none;border:none;background:rgba(255,255,255,.04);color:var(--text);padding:12px 14px;border-radius:12px;cursor:pointer;flex:0 0 auto;min-width:var(--touch-size);min-height:var(--touch-size)}
  @media(max-width:760px){ .dec-btn{display:inline-flex;z-index:6;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.06)} }
  </style>
    </div>
  </div>
</header>

<main class="container">
  <div class="grid">
    <!-- DATE (enhanced) -->
    <section class="card date-card" aria-labelledby="date-title">
      <div class="date-head">
    <div class="date-title"><span class="emoji">ğŸ“…</span><h2 id="date-title" class="section-heading">ØªØ§Ø±ÛŒØ® ÙˆØ±ÙˆØ¯ Ø¯Ø§Ø¯Ù‡ (Ù‡Ø¬Ø±ÛŒ Ø´Ù…Ø³ÛŒ)</h2></div>
        <span class="pill"><span id="weekday-pill">â€”</span></span>
      </div>
      <div class="jalali-input">
        <input id="jalali-date" class="input" placeholder="Ù…Ø«Ø§Ù„: Û±Û´Û°Û´/Û°Û·/Û°Û¹" autocomplete="off">
        <button class="i-btn success" id="btn-today">Ø§Ù…Ø±ÙˆØ²</button>
        <button class="i-btn danger" id="btn-clear-date">Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ</button>
      </div>
      <div class="calendar" id="jalali-calendar" aria-label="ØªÙ‚ÙˆÛŒÙ… Ø´Ù…Ø³ÛŒ">
        <div class="cal-head">
          <div class="nav">
            <button class="i-btn" id="cal-prev">â€¹</button>
            <button class="i-btn" id="cal-next">â€º</button>
          </div>
          <div id="cal-title" class="cal-title"></div>
          <div></div>
        </div>
        <div class="cal-grid" id="cal-weekdays"></div>
        <div class="cal-grid" id="cal-days"></div>
      </div>
      <div class="date-actions">
        <button class="i-btn primary" id="confirm-date">ØªØ£ÛŒÛŒØ¯ ØªØ§Ø±ÛŒØ®</button>
        <button class="i-btn" id="change-date" title="Ù†Ù…Ø§ÛŒØ´ ÙØ±Ù…">Ù†Ù…Ø§ÛŒØ´ ÙØ±Ù…</button>
      </div>
      <!-- Hidden legacy selects to keep logic consistent -->
      <div id="date-setup" class="row old-selects">
        <div class="col"><label for="j-year">Ø³Ø§Ù„</label><select id="j-year" class="select"></select></div>
        <div class="col"><label for="j-month">Ù…Ø§Ù‡</label>
          <select id="j-month" class="select">
            <option value="1">ÙØ±ÙˆØ±Ø¯ÛŒÙ†</option><option value="2">Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª</option><option value="3">Ø®Ø±Ø¯Ø§Ø¯</option>
            <option value="4">ØªÛŒØ±</option><option value="5">Ù…Ø±Ø¯Ø§Ø¯</option><option value="6">Ø´Ù‡Ø±ÛŒÙˆØ±</option>
            <option value="7">Ù…Ù‡Ø±</option><option value="8">Ø¢Ø¨Ø§Ù†</option><option value="9">Ø¢Ø°Ø±</option>
            <option value="10">Ø¯ÛŒ</option><option value="11">Ø¨Ù‡Ù…Ù†</option><option value="12">Ø§Ø³ÙÙ†Ø¯</option>
          </select>
        </div>
        <div class="col"><label for="j-day">Ø±ÙˆØ²</label><select id="j-day" class="select"></select></div>
      </div>
      <div id="date-fixed" class="row initially-hidden">
        <div class="col"><div class="muted-text">Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡: <b id="current-date-jalali">â€”</b> <span id="current-date-greg" class="meta"></span></div></div>
      </div>
      <div class="date-preview" id="date-preview" class="initially-hidden">
        <span class="badge" id="weekday-badge">â€”</span>
        <span id="preview-text">â€”</span>
      </div>
    </section>

    <!-- GOLD -->
    <section class="card" id="gold-tab">
  <h2 class="section-heading brand">Ø·Ù„Ø§ÛŒ Ù…Ø³ØªØ¹Ù…Ù„</h2>
  <div class="row mt-8">
        <div class="col select-wrap">
          <select class="select" id="gold-karat" aria-label="Ø¹ÛŒØ§Ø± Ø·Ù„Ø§"><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø¹ÛŒØ§Ø±</option></select>
          <div class="inline-actions">
            <button class="i-btn" id="gold-opt-add">Ø§ÙØ²ÙˆØ¯Ù†</button>
            <button class="i-btn" id="gold-opt-del">Ø­Ø°Ù</button>
            <button class="i-btn primary" id="gold-record-add">Ø«Ø¨Øª</button>
          </div>
        </div>
  <div class="col"><div class="input-with-dec"><input type="text" class="input" id="gold-weight" placeholder="ÙˆØ²Ù† (Ú¯Ø±Ù…) Ù…Ø«Ø§Ù„: 12.500" inputmode="decimal" pattern="[0-9\u06F0-\u06F9\u0660-\u0669]*[.,]?[0-9\u06F0-\u06F9\u0660-\u0669]*" lang="fa-IR"><button type="button" class="dec-btn" id="dec-insert" aria-hidden="true">.</button></div></div>
      </div>
  <div class="list" id="gold-items-list"><div class="muted-text">Ù‡Ù†ÙˆØ² Ø¢ÛŒØªÙ…ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div></div>
    </section>

    <!-- COINS -->
    <section class="card" id="coins-tab">
  <h2 class="section-heading brand">Ø³Ú©Ù‡â€ŒÙ‡Ø§</h2>
  <div class="row mt-8">
        <div class="col select-wrap">
          <select class="select" id="coin-type" aria-label="Ù†ÙˆØ¹ Ø³Ú©Ù‡"><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ Ø³Ú©Ù‡</option></select>
          <div class="inline-actions">
            <button class="i-btn" id="coin-opt-add">Ø§ÙØ²ÙˆØ¯Ù†</button>
            <button class="i-btn" id="coin-opt-del">Ø­Ø°Ù</button>
            <button class="i-btn primary" id="coin-record-add">Ø«Ø¨Øª</button>
          </div>
        </div>
        <div class="col"><input type="text" class="input" id="coin-count" placeholder="ØªØ¹Ø¯Ø§Ø¯" inputmode="numeric"></div>
      </div>
  <div class="list" id="coin-items-list"><div class="muted-text">Ù‡Ù†ÙˆØ² Ø¢ÛŒØªÙ…ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div></div>
    </section>

    <!-- CASH -->
    <section class="card" id="cash-tab">
  <h2 class="section-heading brand">Ù†Ù‚Ø¯ÛŒÙ†Ú¯ÛŒ</h2>
  <div class="row mt-8">
        <div class="col"><input type="text" class="input" id="cash-amount" placeholder="Ù…Ø¨Ù„Øº Ù†Ù‚Ø¯ÛŒ (Ø±ÛŒØ§Ù„)" inputmode="numeric"></div>
        <button class="i-btn primary" id="save-cash" type="button">Ø°Ø®ÛŒØ±Ù‡</button>
      </div>
  <div class="list" id="cash-note"><div class="muted-text">Ø¢Ø®Ø±ÛŒÙ† Ù…Ø¨Ù„Øº Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ Ø¯Ø± Ø¨Ø§Ù„Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div></div>
    </section>

    <!-- BANK -->
    <section class="card" id="bank-tab">
      <div class="between-row">
        <h2 class="section-heading brand">Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù†Ú©ÛŒ</h2>
        <span class="badge">Ù¾ÛŒÙˆØ³Øª Ø¹Ú©Ø³ Ø±Ø³ÛŒØ¯/Ú©Ø§Ø±Øª</span>
      </div>
      <div class="row mt-8">
        <div class="col select-wrap">
          <select class="select" id="bank-name" aria-label="Ù†Ø§Ù… Ø¨Ø§Ù†Ú©"><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø§Ù†Ú©</option></select>
          <div class="inline-actions">
            <button class="i-btn" id="bank-opt-add">Ø§ÙØ²ÙˆØ¯Ù†</button>
            <button class="i-btn" id="bank-opt-del">Ø­Ø°Ù</button>
            <button class="i-btn primary" id="bank-record-add">Ø«Ø¨Øª</button>
          </div>
        </div>
        <div class="col"><input type="text" class="input" id="card-number" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" inputmode="numeric"></div>
        <div class="col"><input type="text" class="input" id="bank-amount" placeholder="Ù…Ø¨Ù„Øº (Ø±ÛŒØ§Ù„)" inputmode="numeric"></div>
      </div>
      <div class="row mt-8">
  <input id="file-upload" type="file" accept="image/*" class="d-none">
  <!-- `capture` hint is intentionally present to open rear camera on supported mobile browsers; desktop browsers ignore it -->
  <input id="file-camera" type="file" accept="image/*" class="d-none">
        <link rel="icon" href="favicon.ico">
        <style>
        /* Modern polished theme */
        :root{
          --bg:#071018;
          --surface:#0f1923;
          --card:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
          --muted:#9aa4b2;
          --text:#e7ecf3;
          --brand:#D4AF37; --brand-2:#b99728;
          --danger:#ef4444;
          --ring:0 0 0 4px rgba(212,175,55,.14);
          --radius:14px;
          --touch-size:52px;
          --elev-1:0 8px 24px rgba(3,6,16,0.6);
          --elev-2:0 14px 40px rgba(2,8,20,0.65);
          --glass:rgba(255,255,255,0.026);
          --transition-fast:140ms; --transition-med:260ms; --transition-slow:420ms;
        }
        *{box-sizing:border-box;margin:0;padding:0}
        html{color-scheme: light dark}
        body{
          font-family: Vazirmatn, IRANSans, Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Naskh Arabic UI', sans-serif;
          background: radial-gradient(1200px 600px at 10% 10%, rgba(212,175,55,0.03), transparent), linear-gradient(180deg,#061018,#071018);
          color:var(--text);line-height:1.6;padding-bottom:120px;-webkit-font-smoothing:antialiased;
        }

        .appbar{position:sticky;top:0;z-index:60;background:linear-gradient(180deg, rgba(6,8,12,0.6), rgba(6,8,12,0.4)); -webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px);box-shadow:var(--elev-1);border-bottom:1px solid rgba(255,255,255,0.03)}
        .appbar-inner{max-width:980px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;gap:16px}
        .logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand-2));box-shadow:0 8px 30px rgba(217,179,70,0.12);display:inline-block}
        .container{max-width:980px;margin:0 auto;padding:18px}
        .grid{display:grid;grid-template-columns:1fr;gap:18px}
        @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}

        .card{background:var(--surface);background-image:var(--card);border-radius:var(--radius);padding:18px;border:1px solid rgba(255,255,255,0.03);box-shadow:var(--elev-1);transition:transform var(--transition-fast) ease,box-shadow var(--transition-fast) ease}
        .card:hover{transform:translateY(-4px);box-shadow:var(--elev-2)}

        .row{display:flex;flex-wrap:wrap;gap:12px}.col{flex:1 1 220px}
        .select-wrap{position:relative}
        .select,.input{width:100%;padding:12px 14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));color:var(--text);border:1px solid rgba(255,255,255,0.04);transition:box-shadow var(--transition-fast),border-color var(--transition-fast)}
        .select:focus,.input:focus{outline:none;border-color:rgba(212,175,55,0.95);box-shadow:var(--ring)}
        .select-wrap .select{padding-inline-start:14px;padding-inline-end:72px}
        .inline-actions{position:absolute;inset-inline-end:8px;top:50%;transform:translateY(-50%);display:flex;gap:10px}
        .inline-actions .i-btn{padding:10px 12px;min-width:var(--touch-size);min-height:var(--touch-size)}
        .i-btn{border:none;border-radius:12px;padding:12px 14px;cursor:pointer;background:var(--glass);color:var(--text);border:1px solid rgba(255,255,255,0.04);font-size:0.98rem;min-height:var(--touch-size);display:inline-flex;align-items:center;justify-content:center;gap:10px;transition:transform var(--transition-fast),box-shadow var(--transition-fast),background var(--transition-fast)}
        .i-btn:focus-visible{outline:none;box-shadow:var(--ring)}
        .i-btn:hover{transform:translateY(-3px);box-shadow:var(--elev-1)}
        .i-btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#09110b;border:none;font-weight:800;box-shadow:0 8px 28px rgba(184,141,40,0.12)}
        .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
        .btn-sm{padding:10px 12px;font-size:.95rem}
        .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 12px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
        .list{display:flex;flex-direction:column;gap:12px;margin-top:12px}
        .item{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border:1px solid rgba(255,255,255,0.03);padding:12px;border-radius:12px;transition:transform .18s ease,box-shadow .18s ease}
        .item:hover{transform:translateY(-3px);box-shadow:var(--elev-1)}
        .item .meta{color:var(--muted);font-size:.92rem;margin-top:6px}
        .item-actions{display:flex;flex-direction:row;gap:8px;align-items:center}
        .tabs{position:fixed;bottom:14px;left:0;right:0;display:flex;justify-content:center;pointer-events:none}
        .tabs-inner{pointer-events:auto;display:flex;gap:8px;background:linear-gradient(180deg, rgba(8,10,14,0.6), rgba(8,10,14,0.45));-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);border-radius:20px;padding:8px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 10px 30px rgba(3,6,12,0.6)}
        .tab{background:transparent;color:var(--muted);border:none;border-radius:14px;padding:10px 14px;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
        .tab.active{background:linear-gradient(135deg, rgba(212,175,55,0.12), rgba(212,175,55,0.06));color:var(--brand);font-weight:700;box-shadow:0 6px 18px rgba(212,175,55,0.06)}
        .toast{position:fixed;top:22px;right:18px;background:linear-gradient(180deg,#0e1318,#0b0f14);border:1px solid rgba(255,255,255,0.04);color:#fff;padding:10px 14px;border-radius:12px;opacity:0;transform:translateY(-8px);transition:all .18s ease;z-index:100}
        .toast.show{opacity:1;transform:translateY(0)}
        .thumb{width:72px;height:72px;border-radius:10px;object-fit:cover;border:1px solid rgba(255,255,255,0.04);box-shadow:0 8px 20px rgba(0,0,0,0.5)}
        .thumb-wrap{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
        .viewer{position:fixed;inset:0;background:linear-gradient(rgba(3,6,10,0.7), rgba(3,6,10,0.85));display:none;align-items:center;justify-content:center;z-index:200}
        .viewer img{max-width:92vw;max-height:92vh;border-radius:14px;box-shadow:0 40px 120px rgba(0,0,0,0.7)}
        .viewer.show{display:flex}
        .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:12px;background:linear-gradient(180deg, rgba(212,175,55,0.08), rgba(212,175,55,0.02));color:var(--brand);border:1px solid rgba(212,175,55,0.12);font-size:.9rem}
        .help-note{color:var(--muted);font-size:.92rem;margin-top:6px}

        /* utility and layout classes to replace inline styles */
        .header-left{display:flex;align-items:center;gap:12px}
        .app-title{font-weight:800;font-size:1.06rem}
        .app-subtitle{color:var(--muted);font-size:.88rem}
        .appbar-actions{display:flex;gap:10px;align-items:center}
        .section-heading{font-size:1.04rem;font-weight:800}
        .brand{color:var(--brand)}
        .cal-title{font-weight:800}
        .initially-hidden{display:none}
        .muted-text{color:var(--muted)}
        .thumb-offset{margin-left:8px;cursor:pointer}
        .mt-8{margin-top:8px}
        .mt-12{margin-top:12px}
        .between-row{display:flex;align-items:center;justify-content:space-between}
        .mb-10{margin-bottom:10px}
        .mb-8{margin-bottom:8px}
        .d-none{display:none}

        .date-card{background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));border:1px solid rgba(212,175,55,0.12);border-radius:18px;box-shadow:0 10px 40px rgba(0,0,0,0.45)}
        .date-card{transition:transform var(--transition-med) cubic-bezier(.2,.9,.3,1),opacity var(--transition-med) ease,max-height var(--transition-med) ease;transform-origin:top center}
        .date-card.hidden{opacity:0;transform:translateY(-8px) scale(.995);pointer-events:none;max-height:0;overflow:hidden}
        .date-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
        .date-title{display:flex;align-items:center;gap:10px;font-weight:800;color:var(--brand)}
        .date-title .emoji{font-size:1.2rem}
        .jalali-input{display:flex;gap:8px;align-items:center;margin-top:6px}
        .jalali-input .input{flex:1}
        .date-actions{display:flex;gap:8px;justify-content:center;margin-top:10px}
        .i-btn.success{background:linear-gradient(135deg,#22c55e,#16a34a);color:#07110a;border:none;font-weight:800}
        .i-btn.danger{background:linear-gradient(135deg,#ef4444,#dc2626);color:#230b0b;border:none;font-weight:800}
        .i-btn{transition:transform var(--transition-fast) ease,box-shadow var(--transition-fast) ease}
        .i-btn:hover{transform:translateY(-3px);box-shadow:var(--elev-1)}
        .i-btn:active{transform:translateY(0)}
        .calendar{margin-top:10px;border:1px solid rgba(255,255,255,.03);border-radius:14px;padding:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00))}
        .cal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
        .cal-head .nav{display:flex;gap:6px}
        .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
        .cal-cell{padding:10px 0;min-height:44px;border-radius:10px;text-align:center;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.03);cursor:pointer}
        .cal-cell.muted{opacity:.6}
        .cal-cell.today{outline:2px solid var(--brand);}
        .cal-cell.selected{background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#232211;border:none}
        .old-selects{display:none}
        .date-preview{margin-top:10px;display:flex;gap:8px;align-items:center;color:var(--text);font-weight:700}
        .badge{padding:6px 10px;font-weight:700;box-shadow:0 6px 20px rgba(0,0,0,0.45)}

        /* appbar date chip */
        #date-chip{display:none;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:linear-gradient(180deg, rgba(212,175,55,0.06), rgba(212,175,55,0.02));color:var(--brand);border:1px solid rgba(212,175,55,0.12);cursor:pointer;font-weight:700}
        #open-date-btn svg{margin-inline-start:6px;opacity:.95;transform:translateY(1px)}
        @media(max-width:480px){.cal-cell{padding:12px 0;min-height:48px}}
        @media(max-width:640px){
          body{padding-bottom:160px}
          .appbar-inner{padding:10px 12px}
          .app-title{font-size:1.02rem}
          .app-subtitle{display:none}
          .appbar-actions{gap:6px}
          #date-chip{display:none}
          .container{padding:12px}
          .card{padding:14px}
          .row{gap:8px}
          .col{flex:1 1 100%}
          .select,.input{padding:14px 16px;font-size:1rem}
          .i-btn,.btn-ghost{padding:12px 14px;font-size:1rem}
          .btn-sm{padding:10px 12px}
          .cal-cell{padding:14px 0;min-height:54px;font-size:1rem}
          .thumb{width:72px;height:72px}
          .thumb-wrap{gap:10px}
          .item{grid-template-columns:1fr}
          .item-actions{justify-content:flex-start}
          .tabs{bottom:8px}
          .tabs-inner{padding:6px}
          #daily-toolbar{flex-wrap:wrap}
          .inline-actions{inset-inline-end:6px}
          .pill{padding:8px 12px}
        }

        /* decimal helper button (visible on small screens to aid mobile keyboards without decimal key) */
        .input-with-dec{display:flex;align-items:center;gap:8px}
        .input-with-dec .input{flex:1;width:auto}
        .dec-btn{display:none;border:none;background:rgba(255,255,255,.04);color:var(--text);padding:12px 14px;border-radius:12px;cursor:pointer;flex:0 0 auto;min-width:var(--touch-size);min-height:var(--touch-size)}
        @media(max-width:760px){ .dec-btn{display:inline-flex;z-index:6;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.06)} }
    </style>
  <script>
  function applyDate(iso){
  const prev=document.getElementById('date-preview'); const wt=document.getElementById('weekday-badge'); const pt=document.getElementById('preview-text');
  if(prev){ prev.style.display='flex'; wt.textContent=weekdayFaFromISO(iso); pt.textContent=isoToJalali(iso)+' ('+iso+')'; }
  // show chip in appbar
  if(dateChip){ dateChip.textContent = isoToJalali(iso); dateChip.style.display='inline-flex'; }
  hideDateCard();
  showToast('ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª Ø´Ø¯');
}
function showSetup(){ if(dateSetup) dateSetup.style.display='flex'; if(dateFixed) dateFixed.style.display='none'; }

function initDate(){
  const savedISO=localStorage.getItem('currentDate');
  const sessionConfirmed = !!sessionStorage.getItem('dateConfirmed');
  const baseISO = savedISO || todayTehranISODate();
  const y=parseInt(baseISO.slice(0,4)), m=parseInt(baseISO.slice(5,7)), d=parseInt(baseISO.slice(8,10));
  const {jy,jm,jd}=g2j(y,m,d);
  fillYears(jy); if(jMonth) jMonth.value=String(jm); fillDays(jy,jm,jd);

  // init calendar state
  calState={jy,jm,jd,selected: savedISO?{jy:jy,jm:jm,jd:jd}:null};
  renderCalendar();
  const jInput=document.getElementById('jalali-date');
  jInput.value = (savedISO? isoToJalali(savedISO): formatJalali(jy,jm,jd)).replace(/-/g,'/');

  // If the user already confirmed a date in this session, keep the form hidden and apply stored date (if any)
  if(sessionConfirmed){
    if(savedISO){ applyDate(savedISO); }
    else { // no saved date, but user dismissed form earlier this session â€” keep setup hidden and show default preview
      if(dateBadge){ dateBadge.textContent = `${jy}-${String(jm).padStart(2,'0')}-${String(jd).padStart(2,'0')}`; }
      if(dateFixed) dateFixed.style.display = 'none'; if(dateSetup) dateSetup.style.display='none';
      const prev=document.getElementById('date-preview'); if(prev){ prev.style.display='none'; }
      hideDateCard();
    }
  } else {
    if(savedISO){ applyDate(savedISO); } else { if(dateBadge){ dateBadge.textContent = `${jy}-${String(jm).padStart(2,'0')}-${String(jd).padStart(2,'0')}`; } }
    showDateCard();
  }
}

if(jYear) jYear.addEventListener('change',()=>fillDays(parseInt(jYear.value,10), parseInt(jMonth.value,10), Math.min(parseInt(jDay.value||'1',10), daysInJMonth(parseInt(jYear.value,10), parseInt(jMonth.value,10)))));
if(jMonth) jMonth.addEventListener('change',()=>fillDays(parseInt(jYear.value,10), parseInt(jMonth.value,10)));

document.getElementById('btn-today').addEventListener('click',()=>{
  const iso=todayTehranISODate();const {jy,jm,jd}=g2j(parseInt(iso.slice(0,4)), parseInt(iso.slice(5,7)), parseInt(iso.slice(8,10)));
  calState={jy,jm,jd,selected:{jy,jm,jd}}; renderCalendar();
  document.getElementById('jalali-date').value = formatJalali(jy,jm,jd).replace(/-/g,'/');
});
document.getElementById('btn-clear-date').addEventListener('click',()=>{ localStorage.removeItem('currentDate'); sessionStorage.removeItem('dateConfirmed'); currentDate=null; if(dateChip){ dateChip.style.display='none'; dateChip.textContent=''; } showDateCard(); showSetup(); showToast('ØªØ§Ø±ÛŒØ® Ù¾Ø§Ú© Ø´Ø¯'); });

document.getElementById('cal-prev').addEventListener('click',()=>{ calState.jm--; if(calState.jm<1){calState.jm=12; calState.jy--;} renderCalendar(); });
document.getElementById('cal-next').addEventListener('click',()=>{ calState.jm++; if(calState.jm>12){calState.jm=1; calState.jy++;} renderCalendar(); });
const jInput=document.getElementById('jalali-date');
jInput.addEventListener('input',()=>{ const v=parseJalaliStr(jInput.value.replace(/[Ù«.,]/g,'/')); if(v){calState={...calState,jy:v.jy,jm:v.jm,jd:v.jd,selected:{...v}}; renderCalendar();} });

document.getElementById('confirm-date').addEventListener('click',()=>{
  const v=parseJalaliStr(jInput.value.replace(/-/g,'/'));
  if(!v){ alert('ØªØ§Ø±ÛŒØ® Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯. Ù…Ø«Ø§Ù„: Û±Û´Û°Û´/Û°Û·/Û°Û¹'); return; }
  const iso=jalaliToISO(v.jy,v.jm,v.jd); applyDate(iso);
});
document.getElementById('change-date').addEventListener('click',showSetup);

// When user confirms date, set a session flag so the form stays hidden for this session
document.getElementById('confirm-date').addEventListener('click',()=>{
  try{ sessionStorage.setItem('dateConfirmed', '1'); hideDateCard(); }catch(e){}
});

// Populate dropdowns for other tabs
function populate(){
  const g=document.getElementById('gold-karat'); g.textContent=''; g.append(new Option('Ø§Ù†ØªØ®Ø§Ø¨','')); (inventory.karats||[]).forEach(v=>g.append(new Option(v,v)));
  const c=document.getElementById('coin-type'); c.textContent=''; c.append(new Option('Ø§Ù†ØªØ®Ø§Ø¨','')); (inventory.coinTypes||[]).forEach(v=>c.append(new Option(v,v)));
  const b=document.getElementById('bank-name'); b.textContent=''; b.append(new Option('Ø§Ù†ØªØ®Ø§Ø¨','')); (inventory.bankNames||[]).forEach(v=>b.append(new Option(v,v)));
}

// Render lists (no delete buttons per your preference)
const toMg=g=>Math.round(Number(g)*1000), mgToStr=mg=>(Number(mg)/1000).toFixed(3);
function renderGold(){ const wrap=document.getElementById('gold-items-list'); wrap.textContent='';
  if(!(inventory.gold||[]).length){ wrap.innerHTML='<div class="muted-text">Ù‡Ù†ÙˆØ² Ø¢ÛŒØªÙ…ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>'; return; }
  (inventory.gold||[]).forEach((it, idx)=>{ const row=document.createElement('div'); row.className='item';
    const left=document.createElement('div'); left.innerHTML=`<b>${it.karat} Ø¹ÛŒØ§Ø± â€“ ${mgToStr(it.weightMg)} Ú¯Ø±Ù…</b><div class="meta">${it.date?isoToJalali(it.date):'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÛŒØ®'}</div>`;
  const actions=document.createElement('div'); actions.className='item-actions';
  const edit=document.createElement('button'); edit.className='i-btn btn-sm'; edit.setAttribute('title','ÙˆÛŒØ±Ø§ÛŒØ´'); edit.setAttribute('aria-label','ÙˆÛŒØ±Ø§ÛŒØ´ Ø¢ÛŒØªÙ…'); edit.innerHTML='<span aria-hidden="true">âœ</span> ÙˆÛŒØ±Ø§ÛŒØ´'; edit.onclick=()=>{ editGold(idx); };
  const del=document.createElement('button'); del.className='i-btn btn-sm'; del.setAttribute('title','Ø­Ø°Ù'); del.setAttribute('aria-label','Ø­Ø°Ù Ø¢ÛŒØªÙ…'); del.innerHTML='<span aria-hidden="true">âœ•</span> Ø­Ø°Ù'; del.onclick=()=>{ if(confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')){ inventory.gold.splice(idx,1); save(); renderGold(); renderDaily(); showToast('Ø¢ÛŒØªÙ… Ø­Ø°Ù Ø´Ø¯'); } };
  actions.append(edit, del);
  row.append(left, actions); wrap.append(row); });
}

function editGold(idx){ const it=inventory.gold[idx]; if(!it) return; const newK = prompt('Ø¹ÛŒØ§Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:', it.karat); if(newK===null) return; const rawW = prompt('ÙˆØ²Ù† (Ú¯Ø±Ù…) Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 12.500):', (Number(it.weightMg)/1000).toFixed(3)); if(rawW===null) return; const w = parseFloat(normalizeNumInput(rawW)); if(isNaN(w) || w<=0) return alert('ÙˆØ²Ù† Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª'); it.karat = newK.trim(); it.weightMg = Math.round(w*1000); save(); renderGold(); renderDaily(); showToast('Ø¢ÛŒØªÙ… ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯'); }
// Modal-backed editors
const recordModal = document.getElementById('record-modal');
const modalTitle = document.getElementById('modal-title');
const modalBody = document.getElementById('modal-body');
const modalSaveBtn = document.getElementById('modal-save');
const modalCancelBtn = document.getElementById('modal-cancel');
let modalState = { type: null, index: null };

function openRecordModal(type, index){
  modalState = { type, index };
  modalBody.innerHTML = '';
  modalTitle.textContent = type==='gold'? 'ÙˆÛŒØ±Ø§ÛŒØ´ Ø·Ù„Ø§ÛŒ Ù…Ø³ØªØ¹Ù…Ù„' : type==='coin'? 'ÙˆÛŒØ±Ø§ÛŒØ´ Ø³Ú©Ù‡' : 'ÙˆÛŒØ±Ø§ÛŒØ´ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù†Ú©ÛŒ';
  if(type==='gold'){
    const it = inventory.gold[index];
    modalBody.innerHTML = `
      <label>Ø¹ÛŒØ§Ø±<input class="input" id="modal-gold-karat" value="${it.karat}"></label>
      <label class="form-row">ÙˆØ²Ù† (Ú¯Ø±Ù…)<input class="input" id="modal-gold-weight" inputmode="decimal" value="${(it.weightMg/1000).toFixed(3)}"></label>
    `;
  } else if(type==='coin'){
    const it = inventory.coins[index];
    modalBody.innerHTML = `
      <label>Ù†ÙˆØ¹ Ø³Ú©Ù‡<input class="input" id="modal-coin-type" value="${it.type}"></label>
      <label class="form-row">ØªØ¹Ø¯Ø§Ø¯<input class="input" id="modal-coin-count" inputmode="numeric" value="${it.count}"></label>
    `;
  } else if(type==='bank'){
    const it = inventory.banks[index];
    modalBody.innerHTML = `
      <label>Ù†Ø§Ù… Ø¨Ø§Ù†Ú©<input class="input" id="modal-bank-name" value="${it.name}"></label>
      <label class="form-row">Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª<input class="input" id="modal-bank-card" inputmode="numeric" value="${it.cardNumber||''}"></label>
      <label class="form-row">Ù…Ø¨Ù„Øº (Ø±ÛŒØ§Ù„)<input class="input" id="modal-bank-amount" inputmode="numeric" value="${it.amount}"></label>
    `;
  }
  recordModal.classList.add('show'); recordModal.setAttribute('aria-hidden','false');
  // focus first input
  setTimeout(()=>{ const fi = recordModal.querySelector('input'); if(fi){ fi.focus(); fi.select(); } }, 60);
}

function closeRecordModal(){ recordModal.classList.remove('show'); recordModal.setAttribute('aria-hidden','true'); modalState={type:null,index:null}; }

modalCancelBtn.addEventListener('click', ()=>{ closeRecordModal(); });

modalSaveBtn.addEventListener('click', ()=>{
  const {type,index} = modalState; if(!type) return closeRecordModal();
  if(type==='gold'){
    const k = document.getElementById('modal-gold-karat').value.trim();
    const rawW = document.getElementById('modal-gold-weight').value.trim();
    const w = parseFloat(normalizeNumInput(rawW)); if(!k || isNaN(w) || w<=0) return alert('ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯');
    inventory.gold[index].karat = k; inventory.gold[index].weightMg = Math.round(w*1000);
  } else if(type==='coin'){
    const t = document.getElementById('modal-coin-type').value.trim();
    const c = parseInt(normalizeNumInput(document.getElementById('modal-coin-count').value).replace(/\./g,''),10);
    if(!t || isNaN(c) || c<=0) return alert('ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯');
    inventory.coins[index].type = t; inventory.coins[index].count = c;
  } else if(type==='bank'){
    const n = document.getElementById('modal-bank-name').value.trim();
    const cn = document.getElementById('modal-bank-card').value.trim();
    const amt = parseInt(normalizeNumInput(document.getElementById('modal-bank-amount').value).replace(/\D/g,''),10);
    if(!n || isNaN(amt) || amt<0) return alert('ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯');
    inventory.banks[index].name = n; inventory.banks[index].cardNumber = cn; inventory.banks[index].amount = amt;
  }
  save(); renderGold(); renderCoin(); renderBank(); renderDaily(); showToast('Ø¢ÛŒØªÙ… ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯'); closeRecordModal();
});

// Replace prompt-based edit functions with modal openers
function editGold(idx){ if(!inventory.gold[idx]) return; openRecordModal('gold', idx); }
function editCoin(idx){ if(!inventory.coins[idx]) return; openRecordModal('coin', idx); }
function editBank(idx){ if(!inventory.banks[idx]) return; openRecordModal('bank', idx); }
function renderCoin(){ const wrap=document.getElementById('coin-items-list'); wrap.textContent='';
  if(!(inventory.coins||[]).length){ wrap.innerHTML='<div class="muted-text">Ù‡Ù†ÙˆØ² Ø¢ÛŒØªÙ…ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>'; return; }
  (inventory.coins||[]).forEach((it, idx)=>{ const row=document.createElement('div'); row.className='item';
    const left=document.createElement('div'); left.innerHTML=`<b>${it.type} â€“ ${it.count} Ø¹Ø¯Ø¯</b><div class="meta">${it.date?isoToJalali(it.date):'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÛŒØ®'}</div>`;
  const actions=document.createElement('div'); actions.className='item-actions';
  const edit=document.createElement('button'); edit.className='i-btn btn-sm'; edit.setAttribute('title','ÙˆÛŒØ±Ø§ÛŒØ´'); edit.setAttribute('aria-label','ÙˆÛŒØ±Ø§ÛŒØ´ Ø³Ú©Ù‡'); edit.innerHTML='<span aria-hidden="true">âœ</span> ÙˆÛŒØ±Ø§ÛŒØ´'; edit.onclick=()=>{ editCoin(idx); };
  const del=document.createElement('button'); del.className='i-btn btn-sm'; del.setAttribute('title','Ø­Ø°Ù'); del.setAttribute('aria-label','Ø­Ø°Ù Ø³Ú©Ù‡'); del.innerHTML='<span aria-hidden="true">âœ•</span> Ø­Ø°Ù'; del.onclick=()=>{ if(confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')){ inventory.coins.splice(idx,1); save(); renderCoin(); renderDaily(); showToast('Ø¢ÛŒØªÙ… Ø­Ø°Ù Ø´Ø¯'); } };
  actions.append(edit, del);
  row.append(left, actions); wrap.append(row); });
}

function editCoin(idx){ const it=inventory.coins[idx]; if(!it) return; const newType = prompt('Ù†ÙˆØ¹ Ø³Ú©Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:', it.type); if(newType===null) return; const rawC = prompt('ØªØ¹Ø¯Ø§Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:', String(it.count)); if(rawC===null) return; const c = parseInt(normalizeNumInput(rawC).replace(/\./g,''),10); if(isNaN(c) || c<=0) return alert('ØªØ¹Ø¯Ø§Ø¯ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª'); it.type = newType.trim(); it.count = c; save(); renderCoin(); renderDaily(); showToast('Ø¢ÛŒØªÙ… ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯'); }

// BANK photos
let stagedPhotos=[]; const MAX_PHOTOS=3;
function downscaleImage(file, maxW=1280, maxH=1280, quality=0.8){
  return new Promise((resolve,reject)=>{
    const img=new Image();
    img.onload=()=>{
      let w=img.naturalWidth, h=img.naturalHeight;
      const scale=Math.min(1, maxW/w, maxH/h);
      const cw=w*scale, ch=h*scale;
      const canvas=document.createElement('canvas'); canvas.width=cw; canvas.height=ch;
      const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,cw,ch);
      canvas.toBlob(b=>{
        const reader=new FileReader();
        reader.onload=()=>resolve(reader.result);
        reader.onerror=reject;
        reader.readAsDataURL(b);
      }, 'image/jpeg', quality);
    };
    img.onerror=reject;
    const fr=new FileReader();
    fr.onload=()=>{ img.src=fr.result; };
    fr.onerror=reject;
    fr.readAsDataURL(file);
  });
}
function addThumb(dataURL){
  const wrap=document.getElementById('bank-photos-preview');
  const img=document.createElement('img'); img.src=dataURL; img.alt='photo'; img.className='thumb';
  const del=document.createElement('button'); del.textContent='âœ•'; del.className='btn-ghost btn-sm thumb-del';
  const box=document.createElement('div'); box.className='thumb-box'; box.append(img,del);
  img.onclick=()=>openViewer(dataURL);
  del.onclick=()=>{ wrap.removeChild(box); stagedPhotos=stagedPhotos.filter(p=>p!==dataURL); };
  wrap.append(box);
}
// Normalize number-like input: convert Persian/Arabic digits and common separators to ASCII digits and dot
function normalizeNumInput(s){ if(!s && s!==0) return ''; return String(s).replace(/[Ù¬ØŒ\s]/g,'').replace(/[\u0660-\u0669]/g,c=>String(c.charCodeAt(0)-0x0660)).replace(/[\u06F0-\u06F9]/g,c=>String(c.charCodeAt(0)-0x06F0)).replace(/,/g,'.').replace(/Ù«/g,'.'); }
document.getElementById('btn-upload').onclick=()=>document.getElementById('file-upload').click();
document.getElementById('btn-camera').onclick=()=>document.getElementById('file-camera').click();
document.getElementById('file-upload').addEventListener('change', handleFiles, false);
document.getElementById('file-camera').addEventListener('change', handleFiles, false);
async function handleFiles(e){
  const files=[...e.target.files];
  for (const f of files){
    if(stagedPhotos.length>=MAX_PHOTOS){ alert('Ø­Ø¯Ø§Ú©Ø«Ø± Û³ Ø¹Ú©Ø³'); break; }
    try{
      const data=await downscaleImage(f,1280,1280,0.85);
      stagedPhotos.push(data); addThumb(data);
    }catch(err){ console.error(err); alert('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¹Ú©Ø³'); }
  }
  e.target.value='';
}
function openViewer(src){
  const v=document.getElementById('photo-viewer');
  v.querySelector('img').src=src; v.classList.add('show');
}
// decimal helper: insert '.' at caret for inputs that may not have a decimal key on iOS keyboard
const decBtn=document.getElementById('dec-insert');
if(decBtn){ decBtn.addEventListener('click',()=>{
  const inp=document.getElementById('gold-weight'); if(!inp) return;
  const start=inp.selectionStart||inp.value.length; const end=inp.selectionEnd||start;
  const before=inp.value.slice(0,start); const after=inp.value.slice(end);
  inp.value = before + '.' + after; const pos = before.length+1; inp.setSelectionRange(pos,pos); inp.focus();
  showToast('Ø¹Ù„Ø§Ø¦Ù… Ø§Ø¹Ø´Ø§Ø± Ø¯Ø±Ø¬ Ø´Ø¯');
}); }
document.getElementById('photo-viewer').addEventListener('click',e=>{ if(e.target.id==='photo-viewer') e.currentTarget.classList.remove('show'); });
function renderBank(){ const wrap=document.getElementById('bank-cards-list'); wrap.textContent='';
  if(!(inventory.banks||[]).length){ wrap.innerHTML='<div class="muted-text">Ù‡Ù†ÙˆØ² Ø¢ÛŒØªÙ…ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>'; return; }
  (inventory.banks||[]).forEach((it, idx)=>{
    const row=document.createElement('div'); row.className='item';
    const left=document.createElement('div');
    let thumbs=''; (it.photos||[]).forEach((p,pi)=>{ thumbs+=`<img src="${p}" alt="photo ${pi+1}" class="thumb thumb-offset">`; });
    left.innerHTML=`<b>${it.name}</b>
      <div class="meta">${it.cardNumber?('Ú©Ø§Ø±Øª: '+it.cardNumber+' â€“ '):''}${it.date?isoToJalali(it.date):'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÛŒØ®'} | <b>${String(it.amount).replace(/\B(?=(\d{3})+(?!\d))/g,',')} Ø±ÛŒØ§Ù„</b></div>
      <div class="thumb-wrap">${thumbs||''}</div>`;
  const actions=document.createElement('div'); actions.className='item-actions';
  const edit=document.createElement('button'); edit.className='i-btn btn-sm'; edit.setAttribute('title','ÙˆÛŒØ±Ø§ÛŒØ´'); edit.setAttribute('aria-label','ÙˆÛŒØ±Ø§ÛŒØ´ Ø±Ú©ÙˆØ±Ø¯ Ø¨Ø§Ù†Ú©ÛŒ'); edit.innerHTML='<span aria-hidden="true">âœ</span> ÙˆÛŒØ±Ø§ÛŒØ´'; edit.onclick=()=>{ editBank(idx); };
  const del=document.createElement('button'); del.className='i-btn btn-sm'; del.setAttribute('title','Ø­Ø°Ù'); del.setAttribute('aria-label','Ø­Ø°Ù Ø±Ú©ÙˆØ±Ø¯ Ø¨Ø§Ù†Ú©ÛŒ'); del.innerHTML='<span aria-hidden="true">âœ•</span> Ø­Ø°Ù'; del.onclick=()=>{ if(confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯ Ø¨Ø§Ù†Ú©ÛŒ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')){ inventory.banks.splice(idx,1); save(); renderBank(); renderDaily(); showToast('Ø±Ú©ÙˆØ±Ø¯ Ø­Ø°Ù Ø´Ø¯'); } };
  actions.append(edit, del);
  row.append(left, actions); wrap.append(row);
  });
  wrap.querySelectorAll('img.thumb').forEach(img=>img.addEventListener('click',()=>openViewer(img.src)));
}

function editBank(idx){ const it=inventory.banks[idx]; if(!it) return; const newName = prompt('Ù†Ø§Ù… Ø¨Ø§Ù†Ú© Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:', it.name); if(newName===null) return; const newCard = prompt('Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª (Ø®Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù):', it.cardNumber||''); if(newCard===null) return; const rawAmt = prompt('Ù…Ø¨Ù„Øº (Ø±ÛŒØ§Ù„):', String(it.amount)); if(rawAmt===null) return; const amt=parseInt(normalizeNumInput(rawAmt).replace(/\D/g,''),10); if(isNaN(amt) || amt<0) return alert('Ù…Ø¨Ù„Øº Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª'); it.name = newName.trim(); it.cardNumber = newCard.trim(); it.amount = amt; save(); renderBank(); renderDaily(); showToast('Ø±Ú©ÙˆØ±Ø¯ ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯'); }

// Record add inside selects
document.getElementById('gold-record-add').onclick=()=>{
  if(!currentDate) return alert('Ø§Ø¨ØªØ¯Ø§ ØªØ§Ø±ÛŒØ® Ø±Ø§ ØªØ¹ÛŒÛŒÙ† Ú©Ù†ÛŒØ¯');
  const k=document.getElementById('gold-karat').value; const rawW=document.getElementById('gold-weight').value; const w=parseFloat(normalizeNumInput(rawW));
  if(k && !isNaN(w) && w>0){ inventory.gold.push({karat:k,weightMg:Math.round(w*1000),date:currentDate}); save(); renderGold(); renderDaily(); showToast('Ø·Ù„Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ø´Ø¯'); } else alert('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù…Ù„ Ù†ÛŒØ³Øª');
};
document.getElementById('coin-record-add').onclick=()=>{
  if(!currentDate) return alert('Ø§Ø¨ØªØ¯Ø§ ØªØ§Ø±ÛŒØ® Ø±Ø§ ØªØ¹ÛŒÛŒÙ† Ú©Ù†ÛŒØ¯');
  const t=document.getElementById('coin-type').value; const c=parseInt(normalizeNumInput(document.getElementById('coin-count').value).replace(/\./g,''),10);
  if(t && !isNaN(c) && c>0){ inventory.coins.push({type:t,count:c,date:currentDate}); save(); renderCoin(); renderDaily(); showToast('Ø³Ú©Ù‡ Ø«Ø¨Øª Ø´Ø¯'); } else alert('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù…Ù„ Ù†ÛŒØ³Øª');
};
document.getElementById('bank-record-add').onclick=()=>{
  if(!currentDate) return alert('Ø§Ø¨ØªØ¯Ø§ ØªØ§Ø±ÛŒØ® Ø±Ø§ ØªØ¹ÛŒÛŒÙ† Ú©Ù†ÛŒØ¯');
  const name=document.getElementById('bank-name').value;
  const card=document.getElementById('card-number').value;
  const amount=parseInt(normalizeNumInput(document.getElementById('bank-amount').value).replace(/\./g,''),10);
  if(!name || isNaN(amount) || amount<0) return alert('Ø¨Ø§Ù†Ú© Ùˆ Ù…Ø¨Ù„Øº Ø±Ø§ ØµØ­ÛŒØ­ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
  const photos=[...stagedPhotos]; stagedPhotos=[]; document.getElementById('bank-photos-preview').textContent='';
  inventory.banks.push({name,cardNumber:card,amount,date:currentDate,photos});
  save(); renderBank(); renderDaily(); showToast('Ø±Ú©ÙˆØ±Ø¯ Ø¨Ø§Ù†Ú©ÛŒ Ø«Ø¨Øª Ø´Ø¯');
};

// Option add/remove
function promptAddOption(title){ const v=prompt(title+' Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:'); if(!v) return null; return v.trim(); }
function removeSelectedOption(select, list){ const val=select.value; if(!val) return alert('Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); const i=list.indexOf(val); if(i>-1){ list.splice(i,1); save(); return true; } return false; }
document.getElementById('gold-opt-add').onclick=()=>{ const v=promptAddOption('Ø¹ÛŒØ§Ø±'); if(!v) return; (inventory.karats=inventory.karats||[]).push(v); save(); populate(); showToast('Ú¯Ø²ÛŒÙ†Ù‡Ù” Ø¹ÛŒØ§Ø± Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯'); };
document.getElementById('gold-opt-del').onclick=()=>{ const s=document.getElementById('gold-karat'); if(removeSelectedOption(s, inventory.karats)){ populate(); showToast('Ú¯Ø²ÛŒÙ†Ù‡Ù” Ø¹ÛŒØ§Ø± Ø­Ø°Ù Ø´Ø¯'); } };
document.getElementById('coin-opt-add').onclick=()=>{ const v=promptAddOption('Ù†ÙˆØ¹ Ø³Ú©Ù‡'); if(!v) return; (inventory.coinTypes=inventory.coinTypes||[]).push(v); save(); populate(); showToast('Ú¯Ø²ÛŒÙ†Ù‡Ù” Ø³Ú©Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯'); };
document.getElementById('coin-opt-del').onclick=()=>{ const s=document.getElementById('coin-type'); if(removeSelectedOption(s, inventory.coinTypes)){ populate(); showToast('Ú¯Ø²ÛŒÙ†Ù‡Ù” Ø³Ú©Ù‡ Ø­Ø°Ù Ø´Ø¯'); } };
document.getElementById('bank-opt-add').onclick=()=>{ const v=promptAddOption('Ù†Ø§Ù… Ø¨Ø§Ù†Ú©'); if(!v) return; (inventory.bankNames=inventory.bankNames||[]).push(v); save(); populate(); showToast('Ú¯Ø²ÛŒÙ†Ù‡Ù” Ø¨Ø§Ù†Ú© Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯'); };
document.getElementById('bank-opt-del').onclick=()=>{ const s=document.getElementById('bank-name'); if(removeSelectedOption(s, inventory.bankNames)){ populate(); showToast('Ú¯Ø²ÛŒÙ†Ù‡Ù” Ø¨Ø§Ù†Ú© Ø­Ø°Ù Ø´Ø¯'); } };

// Inputs
document.getElementById('card-number').addEventListener('input',e=>{ const d=e.target.value.replace(/\D/g,'').slice(0,16); e.target.value=d.replace(/(\d{4})(?=\d)/g,'$1-'); });

// Format numbers with thousand separators
function formatWithCommas(n){ if(n==null||n==='') return ''; const s=String(n); return s.replace(/\B(?=(\d{3})+(?!\d))/g,','); }

// Live-format cash amount input (thousand separators) with caret preservation
const cashInput = document.getElementById('cash-amount');
if(cashInput){ cashInput.addEventListener('input', (e)=>{
  const el = e.target; const raw = el.value; const selStart = el.selectionStart || 0;
  // normalize Persian/Arabic digits and keep only digits
  const normalized = normalizeNumInput(raw);
  // count digits before caret in the normalized string
  let digitsBefore = 0; for(let i=0;i<selStart;i++){ const ch = raw[i]; const n = normalizeNumInput(ch); if(/\d/.test(n)) digitsBefore++; }
  const clean = normalized.replace(/\D/g,'');
  if(clean===''){ el.value=''; el.setSelectionRange(0,0); return; }
  const formatted = formatWithCommas(clean);
  // determine new caret position based on digitsBefore: walk formatted and find position where digits counted reaches digitsBefore
  let newPos = formatted.length; let counted=0; for(let i=0;i<formatted.length;i++){ if(/\d/.test(formatted[i])) counted++; if(counted>=digitsBefore){ newPos = i+1; break; } }
  el.value = formatted; try{ el.setSelectionRange(newPos,newPos); }catch(e){}
}); }

// Save cash amount: store as integer rials and show formatted note
const saveCashBtn = document.getElementById('save-cash');
if(saveCashBtn){ saveCashBtn.addEventListener('click', ()=>{
  const raw = (cashInput && cashInput.value) ? cashInput.value : '';
  const clean = normalizeNumInput(raw).replace(/\D/g,'');
  const amt = parseInt(clean||'0',10);
  if(isNaN(amt)){ return alert('Ù…Ø¨Ù„Øº Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª'); }
  inventory.cash = amt; save();
  const note = document.getElementById('cash-note'); if(note){ note.innerHTML = `<div class="muted-text">Ø¢Ø®Ø±ÛŒÙ† Ù…Ø¨Ù„Øº Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡: <b>${formatWithCommas(amt)} Ø±ÛŒØ§Ù„</b></div>`; }
  showToast('Ù…Ø¨Ù„Øº Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
}); }

// Tabs
const tabBtns=[...document.querySelectorAll('.tab')];
const panels=['gold','coins','cash','bank','daily'].map(x=>document.getElementById(x+'-tab'));
function showPanel(name){ panels.forEach(p=>p.style.display = (p.id===name+'-tab')?'block':'none'); tabBtns.forEach(b=>b.classList.toggle('active',b.id==='tab-'+name)); }
tabBtns.forEach(btn=>btn.addEventListener('click',()=>{ const name=btn.id.replace('tab-',''); showPanel(name); showToast(btn.textContent+' Ø¨Ø§Ø² Ø´Ø¯'); }));

// Daily aggregation
function renderDaily(){ const wrap=document.getElementById('daily-list'); wrap.textContent=''; const map={}; const ensure=d=>map[d]||(map[d]={gold:0,coin:0,bank:0}); const unk='Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÛŒØ®';
  (inventory.gold||[]).forEach(g=>{ ensure(g.date||unk).gold+=Number(g.weightMg||0); });
  (inventory.coins||[]).forEach(c=>{ ensure(c.date||unk).coin+=Number(c.count||0); });
  (inventory.banks||[]).forEach(b=>{ ensure(b.date||unk).bank+=Number(b.amount||0); });
  const dates=Object.keys(map); if(!dates.length){ wrap.innerHTML='<div class="muted-text">ÙØ¹Ù„Ø§Ù‹ Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>'; return; }
  dates.sort((a,b)=> (a===unk?1:0)-(b===unk?1:0) || (a>b?-1:1));
  dates.forEach(d=>{ const box=document.createElement('div'); box.className='item';
    const left=document.createElement('div'); left.innerHTML=`<b>${d==='Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÛŒØ®'?'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÛŒØ®':(weekdayFaFromISO(d)+' â€“ '+isoToJalali(d))}</b>`;
    const meta=document.createElement('div'); meta.className='meta'; meta.textContent='Ø·Ù„Ø§: '+(map[d].gold/1000).toFixed(3)+' Ú¯Ø±Ù… | Ø³Ú©Ù‡: '+map[d].coin+' Ø¹Ø¯Ø¯ | Ø¨Ø§Ù†Ú©ÛŒ: '+String(map[d].bank).replace(/\B(?=(\d{3})+(?!\d))/g,',')+' Ø±ÛŒØ§Ù„';
    left.append(meta); box.append(left,document.createElement('div')); wrap.append(box); });
}

// Export/Import/Undo/Help
function download(filename, text){ const blob=new Blob([text],{type:'text/plain;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); URL.revokeObjectURL(a.href); }
document.getElementById('btn-export-json').onclick=()=>download('ganjineh.json', JSON.stringify({currentDate,inventory}, null, 2));
document.getElementById('btn-export-csv').onclick=()=>{
  const rows=['type,karat_or_bank_or_coin,amount_or_weight_or_count,date,photos_count'];
  (inventory.gold||[]).forEach(g=>rows.push(`gold,${g.karat},${(g.weightMg/1000).toFixed(3)},${g.date||''},0`));
  (inventory.coins||[]).forEach(c=>rows.push(`coin,${c.type},${c.count},${c.date||''},0`));
  (inventory.banks||[]).forEach(b=>rows.push(`bank,${b.name},${b.amount},${b.date||''},${(b.photos||[]).length}`));
  download('ganjineh.csv', rows.join('\n'));
};
document.getElementById('import-file').addEventListener('change',async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const text=await f.text();
  try{
    if(f.name.endsWith('.json')){ const data=JSON.parse(text); if(data.inventory){ inventory=data.inventory; if(data.currentDate){ localStorage.setItem('currentDate', data.currentDate); currentDate=data.currentDate; } save(); populate(); renderGold(); renderCoin(); renderBank(); renderDaily(); showToast('ÙˆØ±ÙˆØ¯ JSON Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯'); } }
    else{ alert('ÙˆØ±ÙˆØ¯ CSV Ø¯Ø± Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ Ø§Ø³Øª.'); }
  }catch(err){ alert('Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯ ÙØ§ÛŒÙ„'); console.error(err); }
});
document.getElementById('btn-undo').onclick=()=>{ const s=localStorage.getItem('inventory_backup'); if(!s) return alert('Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª'); inventory=JSON.parse(s); save(); populate(); renderGold(); renderCoin(); renderBank(); renderDaily(); showToast('Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø´Ø¯'); };
document.getElementById('btn-help').onclick=()=>alert('Ø±Ø§Ù‡Ù†Ù…Ø§: ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø±Ø§ Ø§Ø² ÙˆØ±ÙˆØ¯ÛŒ ÛŒØ§ ØªÙ‚ÙˆÛŒÙ… Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯Ø› Ø³Ù¾Ø³ ØªØ£ÛŒÛŒØ¯ ØªØ§Ø±ÛŒØ® Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯. Ø¯Ø± Ù‡Ø± ØªØ¨ØŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù†/Ø­Ø°Ù Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø¯Ø§Ø®Ù„ Ù‡Ù…Ø§Ù† Ú©Ø´ÙˆÛŒÛŒ Ù‚Ø±Ø§Ø± Ú¯Ø±ÙØªÙ‡â€ŒØ§Ù†Ø¯. Ø¯Ø± ØªØ¨ Ø¨Ø§Ù†Ú© Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ØªØ§ Û³ Ø¹Ú©Ø³ Ù¾ÛŒÙˆØ³Øª Ú©Ù†ÛŒØ¯.');

// Backup hook
const _save=save; save=function(){ localStorage.setItem('inventory_backup', JSON.stringify(inventory)); _save(); };

// SW guard for file://
const IS_HTTP = location.protocol.startsWith('http');
if (IS_HTTP && 'serviceWorker' in navigator) {
  window.addEventListener('load', ()=>navigator.serviceWorker.register('./sw.js'));
} else if (!IS_HTTP) {
  setTimeout(()=>{ try { const t=document.getElementById('toast'); t.textContent='Ø¨Ø±Ø§ÛŒ ØªØ³Øª PWAØŒ Ø§Ø² http/https Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯ (file:// Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯).'; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2600);} catch(e){} }, 400);
}

// Init
load(); populate(); initDate(); renderGold(); renderCoin(); renderBank(); renderDaily(); showPanel('gold');
</script>
</body>
</html>
