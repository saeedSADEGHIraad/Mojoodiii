diff --git a/index.html b/index.html
index 7df00381b0e20c499c4f355f53efb91b9bb0bbc5..0e7b38b5ff06d44f565ff7b8801f1f97f3d6d752 100644
--- a/index.html
+++ b/index.html
@@ -1,39 +1,60 @@
 <!DOCTYPE html>
-<html lang="fa" dir="rtl">
+<html lang="fa" dir="rtl" data-theme="dark">
 <head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1">
 <title>Ú¯Ù†Ø¬ÛŒÙ†Ù‡ â€“ Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø·Ù„Ø§ÙØ±ÙˆØ´ÛŒ</title>
-<meta name="theme-color" content="#D4AF37">
+<meta name="theme-color" content="#0f1115">
 <link rel="apple-touch-icon" href="icons/icon-192.png">
 <link rel="icon" href="favicon.ico">
 <style>
-:root{--bg:#0f1115;--card:#121621;--muted:#9aa4b2;--text:#e7ecf3;--brand:#D4AF37;--brand-2:#b99728;--danger:#ef4444;--ring:0 0 0 3px rgba(212,175,55,.35);--radius:16px}
+:root{color-scheme:dark;--bg-top:#0c0e12;--bg-bottom:#0f1115;--card:#121621;--muted:#9aa4b2;--text:#e7ecf3;--brand:#D4AF37;--brand-2:#b99728;--danger:#ef4444;--ring:0 0 0 3px rgba(212,175,55,.35);--radius:16px}
+:root[data-theme='light']{color-scheme:light;--bg-top:#fbf7ec;--bg-bottom:#f4efe4;--card:#ffffff;--muted:#4b5565;--text:#1f2933}
 /* UI tokens */
 :root{--space-1:6px;--space-2:12px;--transition-fast:120ms;--transition-med:280ms;--btn-elev:0 8px 20px rgba(0,0,0,.25)}
-*{box-sizing:border-box;margin:0;padding:0}body{font-family:Vazirmatn,IRANSans,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:linear-gradient(180deg,#0c0e12,#0f1115);color:var(--text);line-height:1.75;padding-bottom:110px}
+*{box-sizing:border-box;margin:0;padding:0}body{font-family:Vazirmatn,IRANSans,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:linear-gradient(180deg,var(--bg-top),var(--bg-bottom));color:var(--text);line-height:1.75;padding-bottom:110px}
+html[data-theme='light'] body{color:#1f2933}
+html[data-theme='light'] .appbar{background:linear-gradient(180deg,rgba(255,255,255,.92),rgba(255,255,255,.78));border-bottom:1px solid rgba(212,175,55,.25)}
+html[data-theme='light'] .logo{box-shadow:0 8px 26px rgba(212,175,55,.35)}
+html[data-theme='light'] .card{background:linear-gradient(180deg,rgba(255,255,255,.97),rgba(255,255,255,.9)),#fff;border:1px solid rgba(212,175,55,.2)}
+html[data-theme='light'] .date-card{background:linear-gradient(135deg,#fffdf5,#f7f1e6);border:1px solid rgba(212,175,55,.28)!important;box-shadow:0 10px 30px rgba(212,175,55,.2)}
+html[data-theme='light'] .select,html[data-theme='light'] .input{background:#fff;color:#1f2933;border:1px solid rgba(15,17,21,.12)}
+html[data-theme='light'] .inline-actions .i-btn{background:rgba(15,17,21,.06);color:#1f2933;border-color:rgba(15,17,21,.12)}
+html[data-theme='light'] .btn-ghost{border-color:rgba(15,17,21,.14);color:#1f2933}
+html[data-theme='light'] .tabs-inner{background:rgba(255,255,255,.92);border:1px solid rgba(212,175,55,.25)}
+html[data-theme='light'] .tab{color:#64748b}
+html[data-theme='light'] .tab.active{background:rgba(212,175,55,.18);color:var(--brand)}
+html[data-theme='light'] .item{background:#fff;border:1px solid rgba(212,175,55,.2)}
+html[data-theme='light'] .toast{background:#fff;color:#1f2933;border:1px solid rgba(212,175,55,.3)}
+html[data-theme='light'] .thumb{border:1px solid rgba(15,17,21,.12)}
+html[data-theme='light'] .viewer{background:rgba(15,17,21,.25)}
+html[data-theme='light'] .calendar{background:#fff;border:1px solid rgba(212,175,55,.22)}
+html[data-theme='light'] .cal-cell{background:#fff;border:1px solid rgba(212,175,55,.2)}
+html[data-theme='light'] .cal-cell.selected{color:#1f2933}
+html[data-theme='light'] .badge{background:rgba(212,175,55,.22);color:#8b6a10;border:1px solid rgba(212,175,55,.3)}
+html[data-theme='light'] .pill{background:rgba(212,175,55,.15);border:1px solid rgba(212,175,55,.25);color:#1f2933}
 .appbar{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,rgba(14,16,22,.8),rgba(14,16,22,.6));backdrop-filter:blur(10px);border-bottom:1px solid rgba(212,175,55,.18)}
 .appbar-inner{max-width:920px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
 .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand-2));box-shadow:0 6px 24px rgba(212,175,55,.25)}
 .container{max-width:920px;margin:0 auto;padding:16px}
 .grid{display:grid;grid-template-columns:1fr;gap:16px}@media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
 .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01)),var(--card);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);padding:18px}
 .row{display:flex;flex-wrap:wrap;gap:10px}.col{flex:1 1 220px}
 .select-wrap{position:relative}
 .select,.input{width:100%;padding:12px 14px;border-radius:12px;background:#0b0e14;color:var(--text);border:1px solid rgba(255,255,255,.12)}
 .select-wrap .select{padding-inline-start:14px;padding-inline-end:72px} /* room for inline actions */
 .input:focus,.select:focus{outline:none;border-color:var(--brand);box-shadow:var(--ring)}
 .inline-actions{position:absolute;inset-inline-end:8px;top:50%;transform:translateY(-50%);display:flex;gap:6px} /* place actions on start or end depending on dir */
 .i-btn{border:none;border-radius:8px;padding:6px 8px;cursor:pointer;background:rgba(255,255,255,.06);color:var(--text);border:1px solid rgba(255,255,255,.12);font-size:.85rem}
 .i-btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#232211;border:none;font-weight:800}
 .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.14);color:var(--text)}.btn-sm{padding:8px 10px;font-size:.92rem}
 .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12)}
 .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
 .item{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;background:#0d1018;border:1px solid rgba(255,255,255,.08);padding:12px;border-radius:12px}
 .tabs{position:fixed;bottom:10px;left:0;right:0;display:flex;justify-content:center;pointer-events:none}
 .tabs-inner{pointer-events:auto;display:flex;gap:6px;background:rgba(10,12,18,.7);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.12);padding:8px;border-radius:14px;margin:0 auto}
 .tab{background:transparent;color:#9aa4b2;border:none;border-radius:10px;padding:10px 12px;cursor:pointer}.tab.active{background:rgba(212,175,55,.12);color:var(--brand);font-weight:800}
 .toast{position:fixed;top:80px;right:16px;background:#0e121b;border:1px solid rgba(255,255,255,.12);color:#fff;padding:12px 14px;border-radius:12px;opacity:0;transform:translateY(-10px);transition:all .2s ease;z-index:60}
 .toast.show{opacity:1;transform:translateY(0)}
 .thumb{width:62px;height:62px;border-radius:10px;object-fit:cover;border:1px solid rgba(255,255,255,.12)}
 .thumb-wrap{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
@@ -63,66 +84,83 @@
 .cal-head .nav{display:flex;gap:6px}
 .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
 .cal-cell{padding:10px 0;min-height:44px;border-radius:10px;text-align:center;background:#0b0e14;border:1px solid rgba(255,255,255,.08);cursor:pointer}
 .cal-cell.muted{opacity:.5}
 .cal-cell.today{outline:2px solid var(--brand);}
 .cal-cell.selected{background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#232211;border:none}
 .old-selects{display:none}
 .date-preview{margin-top:10px;display:flex;gap:8px;align-items:center;color:#e7ecf3;font-weight:700}
 .badge{padding:6px 10px;font-weight:700;box-shadow:0 4px 12px rgba(0,0,0,.35)}

 /* appbar date chip */
 #date-chip{display:none;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(212,175,55,.08);color:var(--brand);border:1px solid rgba(212,175,55,.18);cursor:pointer;font-weight:700}
 #open-date-btn svg{margin-inline-start:6px;opacity:.95;transform:translateY(1px)}
 @media(max-width:480px){.cal-cell{padding:12px 0;min-height:48px}}
 </style>
 <script>
   // Inject manifest only on http(s) to avoid CORS on file://
   (function(){
     const IS_HTTP = location.protocol.startsWith('http');
     if (IS_HTTP) {
       const m = document.createElement('link');
       m.rel='manifest'; m.href='manifest.webmanifest'; document.head.appendChild(m);
     }
   })();
 </script>
+<script>
+  (function(){
+    const STORAGE_KEY='ganjineh_theme';
+    const prefersLight=()=> window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
+    let theme='dark';
+    try{
+      const stored=localStorage.getItem(STORAGE_KEY);
+      if(stored==='light' || stored==='dark'){ theme=stored; }
+      else if(prefersLight()){ theme='light'; }
+    }catch(e){
+      if(prefersLight()){ theme='light'; }
+    }
+    document.documentElement.dataset.theme=theme;
+    var meta=document.querySelector('meta[name="theme-color"]');
+    if(meta){ meta.setAttribute('content', theme==='light'?'#f6f1e4':'#0f1115'); }
+  })();
+</script>
 </head>
 <body>
 <header class="appbar">
   <div class="appbar-inner">
     <div style="display:flex;align-items:center;gap:12px">
       <div class="logo" aria-hidden="true"></div>
       <div><div style="font-weight:800">Ú¯Ù†Ø¬ÛŒÙ†Ù‡</div><div style="color:#9aa4b2;font-size:.86rem">Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø·Ù„Ø§ÙØ±ÙˆØ´ÛŒ</div></div>
     </div>
     <div style="display:flex;gap:8px;align-items:center">
       <button class="btn-ghost btn-sm" id="print-btn">Ú†Ø§Ù¾</button>
       <button class="btn-ghost btn-sm" id="open-date-btn" title="Ù†Ù…Ø§ÛŒØ´/ØªØºÛŒÛŒØ± ØªØ§Ø±ÛŒØ®">
         <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M7 11h5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><rect x="3" y="5" width="18" height="16" rx="2" stroke="currentColor" stroke-width="1.4"/></svg>
         ØªØ§Ø±ÛŒØ®
       </button>
       <div id="date-chip" title="ØªØ§Ø±ÛŒØ® Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡"></div>
-      <button class="btn-ghost btn-sm" id="theme-toggle">Ø­Ø§Ù„Øª Ø±ÙˆØ´Ù†/ØªØ§Ø±ÛŒÚ©</button>
+      <button class="btn-ghost btn-sm" id="theme-toggle" aria-pressed="false">Ø­Ø§Ù„Øª Ø±ÙˆØ´Ù†</button>
     </div>
   </div>
 </header>

 <main class="container">
   <div class="grid">
     <!-- DATE (enhanced) -->
     <section class="card date-card" aria-labelledby="date-title">
       <div class="date-head">
         <div class="date-title"><span class="emoji">ğŸ“…</span><h2 id="date-title" style="font-size:1.05rem">ØªØ§Ø±ÛŒØ® ÙˆØ±ÙˆØ¯ Ø¯Ø§Ø¯Ù‡ (Ù‡Ø¬Ø±ÛŒ Ø´Ù…Ø³ÛŒ)</h2></div>
         <span class="pill"><span id="weekday-pill">â€”</span></span>
       </div>
       <div class="jalali-input">
         <input id="jalali-date" class="input" placeholder="Ù…Ø«Ø§Ù„: Û±Û´Û°Û´/Û°Û·/Û°Û¹" autocomplete="off">
         <button class="i-btn success" id="btn-today">Ø§Ù…Ø±ÙˆØ²</button>
         <button class="i-btn danger" id="btn-clear-date">Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ</button>
       </div>
       <div class="calendar" id="jalali-calendar" aria-label="ØªÙ‚ÙˆÛŒÙ… Ø´Ù…Ø³ÛŒ">
         <div class="cal-head">
           <div class="nav">
             <button class="i-btn" id="cal-prev">â€¹</button>
             <button class="i-btn" id="cal-next">â€º</button>
           </div>
           <div id="cal-title" style="font-weight:800"></div>
           <div></div>
@@ -241,85 +279,139 @@
         <label class="btn-ghost btn-sm" for="import-file">ÙˆØ±ÙˆØ¯ Ø§Ø² ÙØ§ÛŒÙ„</label>
         <input id="import-file" type="file" accept=".json,.csv" style="display:none">
         <button class="btn-ghost btn-sm" id="btn-undo">ÙˆØ§Ú¯Ø±Ø¯</button>
         <button class="btn-ghost btn-sm" id="btn-help">Ø±Ø§Ù‡Ù†Ù…Ø§</button>
       </div>
       <div id="daily-list"><div style="color:#9aa4b2">ÙØ¹Ù„Ø§Ù‹ Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div></div>
     </section>
   </div>
 </main>

 <div class="tabs">
   <div class="tabs-inner">
     <button class="tab active" id="tab-gold">Ø·Ù„Ø§ÛŒ Ù…Ø³ØªØ¹Ù…Ù„</button>
     <button class="tab" id="tab-coins">Ø³Ú©Ù‡â€ŒÙ‡Ø§</button>
     <button class="tab" id="tab-cash">Ù†Ù‚Ø¯ÛŒÙ†Ú¯ÛŒ</button>
     <button class="tab" id="tab-bank">Ø¨Ø§Ù†Ú©</button>
     <button class="tab" id="tab-daily">Ø±ÙˆØ²Ø§Ù†Ù‡</button>
   </div>
 </div>

 <div class="viewer" id="photo-viewer"><img alt="preview"></div>
 <div class="toast" id="toast"></div>

 <script>
 const toast=document.getElementById('toast');
-function showToast(m){toast.textContent=m;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),1600)}
-document.getElementById('theme-toggle').addEventListener('click',()=>{ document.documentElement.classList.toggle('light'); showToast('Ø­Ø§Ù„Øª Ù†Ù…Ø§ÛŒØ´ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯'); });
+const themeToggleBtn=document.getElementById('theme-toggle');
+const themeMeta=document.querySelector('meta[name="theme-color"]');
+const THEME_STORAGE_KEY='ganjineh_theme';
+const THEME_COLORS={dark:'#0f1115',light:'#f6f1e4'};
+function showToast(m){if(!toast) return;toast.textContent=m;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),1600)}
+function applyTheme(theme,{persist=true}={}){
+  const normalized=theme==='light'?'light':'dark';
+  const isLight=normalized==='light';
+  document.documentElement.dataset.theme=normalized;
+  if(themeMeta){ themeMeta.setAttribute('content', isLight?THEME_COLORS.light:THEME_COLORS.dark); }
+  if(themeToggleBtn){
+    themeToggleBtn.textContent=isLight?'Ø­Ø§Ù„Øª ØªØ§Ø±ÛŒÚ©':'Ø­Ø§Ù„Øª Ø±ÙˆØ´Ù†';
+    themeToggleBtn.setAttribute('aria-pressed', isLight?'true':'false');
+  }
+  if(persist){
+    try{ localStorage.setItem(THEME_STORAGE_KEY, normalized); }
+    catch(e){ console.warn('Theme preference not saved', e); }
+  }
+}
+let savedTheme=document.documentElement.dataset.theme||'dark';
+try{
+  const stored=localStorage.getItem(THEME_STORAGE_KEY);
+  if(stored==='light' || stored==='dark') savedTheme=stored;
+  else if(window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) savedTheme='light';
+}catch(e){ console.warn('Theme preference unavailable', e); }
+applyTheme(savedTheme,{persist:false});
+if(themeToggleBtn){
+  themeToggleBtn.addEventListener('click',()=>{
+    const nextTheme=document.documentElement.dataset.theme==='light'?'dark':'light';
+    applyTheme(nextTheme);
+    showToast(nextTheme==='light'?'Ø­Ø§Ù„Øª Ø±ÙˆØ´Ù† ÙØ¹Ø§Ù„ Ø´Ø¯':'Ø­Ø§Ù„Øª ØªØ§Ø±ÛŒÚ© ÙØ¹Ø§Ù„ Ø´Ø¯');
+  });
+}
+if(window.matchMedia){
+  const media=window.matchMedia('(prefers-color-scheme: light)');
+  const handlePrefChange=ev=>{
+    let stored=null;
+    try{ stored=localStorage.getItem(THEME_STORAGE_KEY); }
+    catch(e){ stored=null; }
+    if(stored==='light' || stored==='dark') return;
+    applyTheme(ev.matches?'light':'dark',{persist:false});
+  };
+  if(typeof media.addEventListener==='function') media.addEventListener('change',handlePrefChange);
+  else if(typeof media.addListener==='function') media.addListener(handlePrefChange);
+}
 document.getElementById('print-btn').addEventListener('click',()=>window.print());
 // Open date form from appbar (allows reopening during same session)
 const openDateBtn = document.getElementById('open-date-btn');
 const dateCardEl = document.querySelector('.date-card');
 const dateChip = document.getElementById('date-chip');
 function showDateCard(){ if(dateCardEl){ dateCardEl.classList.remove('hidden'); dateCardEl.style.removeProperty('display'); } }
 function hideDateCard(){ if(dateCardEl){ dateCardEl.classList.add('hidden'); /* keep display removed to allow layout */ } }
 if(openDateBtn){ openDateBtn.addEventListener('click',()=>{ showDateCard(); showSetup(); const inp=document.getElementById('jalali-date'); if(inp){ inp.focus(); inp.select(); } }); }

 // Jalali conversion + date helpers
 function g2j(gy, gm, gd){const g_d_m=[0,31,59,90,120,151,181,212,243,273,304,334];let gy2=(gm>2)?(gy+1):gy;let days=355666+(365*gy)+Math.floor((gy2+3)/4)-Math.floor((gy2+99)/100)+Math.floor((gy2+399)/400)+gd+g_d_m[gm-1];let jy=-1595+33*Math.floor(days/12053);days%=12053;jy+=4*Math.floor(days/1461);days%=1461;if(days>365){jy+=Math.floor((days-1)/365);days=(days-1)%365;}let jm=(days<186)?1+Math.floor(days/31):7+Math.floor((days-186)/30);let jd=1+((days<186)?(days%31):((days-186)%30));return {jy,jm,jd};}
 function j2g(jy,jm,jd){jy=parseInt(jy,10);jm=parseInt(jm,10);jd=parseInt(jd,10);let jy2=jy+1595;let days=-355668+(365*jy2)+Math.floor(jy2/33)*8+Math.floor(((jy2%33)+3)/4)+jd+(jm<7?(jm-1)*31:(jm-7)*30+186);let gy=400*Math.floor(days/146097);days%=146097;if(days>36524){gy+=100*Math.floor(--days/36524);days%=36524;if(days>=365)days++;}gy+=4*Math.floor(days/1461);days%=1461;if(days>365){gy+=Math.floor((days-1)/365);days=(days-1)%365;}let gd=days+1;const sal_a=[31,((gy%4===0&&gy%100!==0)||(gy%400===0))?29:28,31,30,31,30,31,31,30,31,30,31];let gm=0;for(gm=1;gm<=12&&gd>sal_a[gm-1];gm++){gd-=sal_a[gm-1];}return {gy,gm,gd};}
 function isoToJalali(iso){const [y,m,d]=iso.split('-').map(v=>parseInt(v,10));const {jy,jm,jd}=g2j(y,m,d);return `${jy}-${String(jm).padStart(2,'0')}-${String(jd).padStart(2,'0')}`;}
 function jalaliToISO(jy,jm,jd){const {gy,gm,gd}=j2g(jy,jm,jd);return `${String(gy).padStart(4,'0')}-${String(gm).padStart(2,'0')}-${String(gd).padStart(2,'0')}`;}
 function weekdayFaFromISO(iso){const dt=new Date(iso+'T12:00:00+03:30');return ['ÛŒÚ©â€ŒØ´Ù†Ø¨Ù‡','Ø¯Ùˆâ€ŒØ´Ù†Ø¨Ù‡','Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡','Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡','Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡','Ø¬Ù…Ø¹Ù‡','Ø´Ù†Ø¨Ù‡'][dt.getDay()];}
 function todayTehranISODate(){try{return new Intl.DateTimeFormat('en-CA',{timeZone:'Asia/Tehran',year:'numeric',month:'2-digit',day:'2-digit'}).format(new Date());}catch(e){const now=new Date();const utc=now.getTime()+now.getTimezoneOffset()*60000;const tehran=new Date(utc+3.5*3600*1000);return new Date(tehran).toISOString().slice(0,10);}}
 const J_MONTHS=['ÙØ±ÙˆØ±Ø¯ÛŒÙ†','Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª','Ø®Ø±Ø¯Ø§Ø¯','ØªÛŒØ±','Ù…Ø±Ø¯Ø§Ø¯','Ø´Ù‡Ø±ÛŒÙˆØ±','Ù…Ù‡Ø±','Ø¢Ø¨Ø§Ù†','Ø¢Ø°Ø±','Ø¯ÛŒ','Ø¨Ù‡Ù…Ù†','Ø§Ø³ÙÙ†Ø¯'];
 function parseJalaliStr(s){const m=s.replace(/\s/g,'').match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})$/); if(!m) return null; const jy=+m[1], jm=+m[2], jd=+m[3]; return {jy,jm,jd};}
 function formatJalali(jy,jm,jd){return jy+'-'+String(jm).padStart(2,'0')+'-'+String(jd).padStart(2,'0');}

 // State
 let currentDate=null;
 let inventory={ gold:[], coins:[], banks:[], cash:0, cashLog:[], karats:['18','21','24'], coinTypes:['Ø¨Ù‡Ø§Ø± Ø¢Ø²Ø§Ø¯ÛŒ','Ù†ÛŒÙ… Ø³Ú©Ù‡','Ø±Ø¨Ø¹ Ø³Ú©Ù‡','Ø³Ú©Ù‡ Ú¯Ø±Ù…ÛŒ'], bankNames:['Ù…Ù„ÛŒ','Ù…Ù„Øª','ØµØ§Ø¯Ø±Ø§Øª','Ù¾Ø§Ø±Ø³ÛŒØ§Ù†','ØªØ¬Ø§Ø±Øª','Ø±ÙØ§Ù‡','Ø³Ø§Ù…Ø§Ù†'] };

 // Elements
 const jYear=document.getElementById('j-year'), jMonth=document.getElementById('j-month'), jDay=document.getElementById('j-day');
 const dateSetup=document.getElementById('date-setup'), dateFixed=document.getElementById('date-fixed');
 const weekdayPill=document.getElementById('weekday-pill');
 const currentDateJ=document.getElementById('current-date-jalali');
 const currentDateG=document.getElementById('current-date-greg');
 const dateBadge=document.getElementById('date-badge');

-function save(){ localStorage.setItem('inventory',JSON.stringify(inventory)); }
+function save(){
+  try{
+    const prev=localStorage.getItem('inventory');
+    if(prev!==null){
+      localStorage.setItem('inventory_backup', prev);
+    }
+    localStorage.setItem('inventory',JSON.stringify(inventory));
+  }catch(err){
+    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª', err);
+    showToast('Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯');
+  }
+}
 function load(){ const s=localStorage.getItem('inventory'); if(s){ try{ inventory={...inventory,...JSON.parse(s)} }catch{} } }

 function isJLeap(jy){const g=j2g(jy,12,30);const back=g2j(g.gy,g.gm,g.gd);return back.jd===30&&back.jm===12;}
 function daysInJMonth(jy,jm){if(jm<=6)return 31;if(jm<=11)return 30;return isJLeap(jy)?30:29;}
 function fillYears(centerJy){ if(!jYear) return; jYear.textContent=''; for(let y=centerJy-5;y<=centerJy+5;y++){const opt=document.createElement('option');opt.value=String(y);opt.textContent=String(y);if(y===centerJy)opt.selected=true;jYear.appendChild(opt);} }
 function fillDays(jy,jm,selected=null){ if(!jDay) return; jDay.textContent='';const n=daysInJMonth(jy,jm);for(let d=1;d<=n;d++){const opt=document.createElement('option');opt.value=String(d);opt.textContent=String(d).padStart(2,'0');if(selected && d===selected)opt.selected=true;jDay.appendChild(opt);} }

 // Calendar UI
 let calState={jy:1400,jm:1,jd:1,selected:null};
 function renderCalendar(){
   const wdGrid=document.getElementById('cal-weekdays'); const dGrid=document.getElementById('cal-days');
   if(!wdGrid || !dGrid) return;
   wdGrid.textContent=''; ['Ø´','ÛŒ','Ø¯','Ø³','Ú†','Ù¾','Ø¬'].forEach(l=>{ const c=document.createElement('div'); c.className='cal-cell muted'; c.textContent=l; wdGrid.append(c); });
   dGrid.textContent='';
   const title=document.getElementById('cal-title'); if(title) title.textContent=J_MONTHS[calState.jm-1]+' '+calState.jy;
   const startISO=jalaliToISO(calState.jy,calState.jm,1);
   const start = new Date(startISO+'T12:00:00+03:30');
   const firstWd = (start.getDay()+6)%7; // Saturday index 0
   const dim = daysInJMonth(calState.jy, calState.jm);
   for(let i=0;i<firstWd;i++){ const p=document.createElement('div'); p.className='cal-cell muted'; p.textContent=''; dGrid.append(p); }
   const todayISO=todayTehranISODate(); const {jy:tjy,jm:tjm,jd:tjd}=g2j(parseInt(todayISO.slice(0,4)),parseInt(todayISO.slice(5,7)),parseInt(todayISO.slice(8,10)));
   for(let d=1; d<=dim; d++){
     const c=document.createElement('div'); c.className='cal-cell'; c.textContent=String(d);
     if(tjy===calState.jy && tjm===calState.jm && tjd===d) c.classList.add('today');
     if(calState.selected && calState.selected.jy===calState.jy && calState.selected.jm===calState.jm && calState.selected.jd===d) c.classList.add('selected');
@@ -548,41 +640,38 @@
     const meta=document.createElement('div'); meta.className='meta'; meta.textContent='Ø·Ù„Ø§: '+(map[d].gold/1000).toFixed(3)+' Ú¯Ø±Ù… | Ø³Ú©Ù‡: '+map[d].coin+' Ø¹Ø¯Ø¯ | Ø¨Ø§Ù†Ú©ÛŒ: '+String(map[d].bank).replace(/\B(?=(\d{3})+(?!\d))/g,',')+' Ø±ÛŒØ§Ù„';
     left.append(meta); box.append(left,document.createElement('div')); wrap.append(box); });
 }

 // Export/Import/Undo/Help
 function download(filename, text){ const blob=new Blob([text],{type:'text/plain;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); URL.revokeObjectURL(a.href); }
 document.getElementById('btn-export-json').onclick=()=>download('ganjineh.json', JSON.stringify({currentDate,inventory}, null, 2));
 document.getElementById('btn-export-csv').onclick=()=>{
   const rows=['type,karat_or_bank_or_coin,amount_or_weight_or_count,date,photos_count'];
   (inventory.gold||[]).forEach(g=>rows.push(`gold,${g.karat},${(g.weightMg/1000).toFixed(3)},${g.date||''},0`));
   (inventory.coins||[]).forEach(c=>rows.push(`coin,${c.type},${c.count},${c.date||''},0`));
   (inventory.banks||[]).forEach(b=>rows.push(`bank,${b.name},${b.amount},${b.date||''},${(b.photos||[]).length}`));
   download('ganjineh.csv', rows.join('\n'));
 };
 document.getElementById('import-file').addEventListener('change',async (e)=>{
   const f=e.target.files[0]; if(!f) return;
   const text=await f.text();
   try{
     if(f.name.endsWith('.json')){ const data=JSON.parse(text); if(data.inventory){ inventory=data.inventory; if(data.currentDate){ localStorage.setItem('currentDate', data.currentDate); currentDate=data.currentDate; } save(); populate(); renderGold(); renderCoin(); renderBank(); renderDaily(); showToast('ÙˆØ±ÙˆØ¯ JSON Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯'); } }
     else{ alert('ÙˆØ±ÙˆØ¯ CSV Ø¯Ø± Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ Ø§Ø³Øª.'); }
   }catch(err){ alert('Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯ ÙØ§ÛŒÙ„'); console.error(err); }
 });
 document.getElementById('btn-undo').onclick=()=>{ const s=localStorage.getItem('inventory_backup'); if(!s) return alert('Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª'); inventory=JSON.parse(s); save(); populate(); renderGold(); renderCoin(); renderBank(); renderDaily(); showToast('Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø´Ø¯'); };
 document.getElementById('btn-help').onclick=()=>alert('Ø±Ø§Ù‡Ù†Ù…Ø§: ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø±Ø§ Ø§Ø² ÙˆØ±ÙˆØ¯ÛŒ ÛŒØ§ ØªÙ‚ÙˆÛŒÙ… Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯Ø› Ø³Ù¾Ø³ ØªØ£ÛŒÛŒØ¯ ØªØ§Ø±ÛŒØ® Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯. Ø¯Ø± Ù‡Ø± ØªØ¨ØŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù†/Ø­Ø°Ù Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø¯Ø§Ø®Ù„ Ù‡Ù…Ø§Ù† Ú©Ø´ÙˆÛŒÛŒ Ù‚Ø±Ø§Ø± Ú¯Ø±ÙØªÙ‡â€ŒØ§Ù†Ø¯. Ø¯Ø± ØªØ¨ Ø¨Ø§Ù†Ú© Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ØªØ§ Û³ Ø¹Ú©Ø³ Ù¾ÛŒÙˆØ³Øª Ú©Ù†ÛŒØ¯.');

-// Backup hook
-const _save=save; save=function(){ localStorage.setItem('inventory_backup', JSON.stringify(inventory)); _save(); };
-
 // SW guard for file://
 const IS_HTTP = location.protocol.startsWith('http');
 if (IS_HTTP && 'serviceWorker' in navigator) {
   window.addEventListener('load', ()=>navigator.serviceWorker.register('./sw.js'));
 } else if (!IS_HTTP) {
   setTimeout(()=>{ try { const t=document.getElementById('toast'); t.textContent='Ø¨Ø±Ø§ÛŒ ØªØ³Øª PWAØŒ Ø§Ø² http/https Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯ (file:// Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯).'; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2600);} catch(e){} }, 400);
 }

 // Init
 load(); populate(); initDate(); renderGold(); renderCoin(); renderBank(); renderDaily(); showPanel('gold');
 </script>
 </body>
 </html>
 